SHELL=/bin/bash

remove_lock:
	rm -f .terraform.lock.hcl

	for dir in service/*; do \
		echo "$$dir"; \
		if [ -d "$$dir" ]; then \
			rm -f "$$dir/.terraform.lock.hcl"; \
		fi; \
	 done;

init:
	terraform init -upgrade; 

	for dir in service/*; do \
		echo "$$dir"; \
		if [ -d "$$dir" ]; then \
			terraform -chdir="$$dir" init -upgrade; \
		fi; \
	 done;

versions:
	echo "$$VERSIONS_VAR" > "versions.tf";

	for dir in service/*; do \
		echo "$$dir"; \
		if [ -d "$$dir" ]; then \
			echo "$$VERSIONS_VAR" > "$$dir/versions.tf"; \
		fi; \
	done;
	


define VERSIONS_VAR
	terraform {
		required_providers {
			observe = {
				source  = "terraform.observeinc.com/observeinc/observe"
				version = "~> 0.10.4"
			}
		}
		required_version = ">= 0.13.0"
	}

endef

export VERSIONS_VAR 

countMetrics:
	cat service/compute/computedescriptors.json| jq -r '[.metricDescriptors[] | select (.launchStage=="GA") | .launchStage] | length';

	cat service/cloudsql/cloudsqldescriptors.json| jq -r '[.metricDescriptors[] | select (.launchStage=="GA") | .launchStage] | length'
