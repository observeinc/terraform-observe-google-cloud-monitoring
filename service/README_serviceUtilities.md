## Refreshing metrics
Run ```./serviceUtilities.py -h``` for list of commands

Workflow is to run fetch_metric_descriptors and then create_terraform to create an autogenerated file with a local.metrics_definitions map variable containing metric metadata used in set_metric opal statement.

### Example

This fetches data from gcp api and creates a json file to be read by next function
```
./serviceUtilities.py fetch_metric_descriptors -o compute/computemetrics.json -m "compute.googleapis.com"

./serviceUtilities.py fetch_metric_descriptors -o bigquery/bigquerymetrics.json -m "bigquery.googleapis.com"

./serviceUtilities.py fetch_metric_descriptors -o cloudfunctions/cloudfunctionmetrics.json -m "cloudfunctions.googleapis.com"

./serviceUtilities.py fetch_metric_descriptors -o cloudsql/cloudsqlmetrics.json -m "cloudsql.googleapis.com"
```

This reads json file and creates local_metricdescriptors.tf file with local variable defined that can be read in metrics dataset definition.

```
./serviceUtilities.py create_terraform -i compute/computemetrics.json -t compute/local_metricdescriptors.tf 

./serviceUtilities.py create_terraform -i bigquery/bigquerymetrics.json -t bigquery/local_metricdescriptors.tf 

./serviceUtilities.py create_terraform -i cloudfunctions/cloudfunctionmetrics.json -t cloudfunctions/local_metricdescriptors.tf 

./serviceUtilities.py create_terraform -i cloudsql/cloudsqlmetrics.json -t cloudsql/local_metricdescriptors.tf 
```

## Changing metric definitions
Some metrics may not have correct properties for attributes needed by set_metric.  In this case we use a file called local_metricdescriptors_over_rides.tf to override certain properties in the auto generated terraform local variable.

### Example
The file defines another local variable that combines the auto generated local.metrics_definitions with another variable local.metrics_definitions_overrides.

For any metric defined in the auto generated local_metricdescriptors.tf file - for example cpu_utilization - we can create a corresponding definition that overrides specific properties of the metric in local_metricdescriptors_over_rides.tf

```
# FROM local_metricdescriptors.tf
  cpu_utilization = {
    type               = "gauge"
    description        = <<-EOF
                    Fractional utilization of allocated CPU on this instance. Values are typically numbers between 0.0 and 1.0 but some machine types allow bursting above 1.0. Charts display the values as a percentage between 0% and 100% or more. This metric is reported by the hypervisor for the VM and can differ from `agent.googleapis.com/cpu/utilization`, which is reported from inside the VM.
                EOF
    launchStage        = "GA"
    rollup             = "avg"
    aggregate          = "sum"
    metricCategory     = "cpu"
    google_metric_path = "compute.googleapis.com/instance/cpu/utilization"
    label              = "CPU utilization"
    unit               = "10^2.%"
    metricBin          = "instance"
    valuetype          = "DOUBLE"

  }
  ```

```
locals {
  override_keys = keys(local.metrics_definitions_overrides)
  # if local.metrics_definitions has an overide value in local.metrics_definitions_overrides then use value from local.metrics_definitions_overrides
  merged_metrics_definitions = { for key1, value1 in local.metrics_definitions : # loop
    key1 => {
      for key2, value2 in value1 :
      key2 => contains(local.override_keys, key1) ?                     # check if metric key in override map
      contains(keys(local.metrics_definitions_overrides[key1]), key2) ? # check if property in override map for given key
      local.metrics_definitions_overrides[key1][key2] : value2          # use if present otherwise use existing
      : value2                                                          # otherwise use existing
    }
  }


# This will change the rollup and unit properties of the cpu_utilization metric defined in local.metrics_definitions 

  metrics_definitions_overrides = {
    cpu_utilization = {
      rollup = "rate"
      unit   = "second"
    }
  }
}


```

## Metrics file
To use these variables to auoto generate the opal statements needed in your metrics definition file the last stage of your metrics dataset should contain the following (include comments for helping out future users who come across code)

```
 # The terraform below dynamically writes set_metric statements in opal
  # This loops through the local.metrics_definitions map using for
  # [for metric, options in local.metrics_definitions :

  # metric is the key (avg_ttl) and options is the value (all the stuff between {})
  /* Example metric in local.metrics_definitions
        avg_ttl = {
            type               = "gauge"
            description        = <<-EOF
                            Average TTL for keys in this database.
                        EOF
            launchStage        = "GA"
            rollup             = "avg"
            aggregate          = "sum"
            metricCategory     = "none"
            google_metric_path = "redis.googleapis.com/keyspace/avg_ttl"
            label              = "Average TTL"
            unit               = "ms"
            metricBin          = "keyspace"
            valuetype          = "DOUBLE"

        }
        */

  # We filter the outer for loop checking whether options.launchStage is in the array defined by var.metric_launch_stages 
  # in the inner for loop we iterate through the fields in the options objects and check if the field is in the array defined by var.metric_interface_fields
  ##  and if so 
  /* Example output
  set_metric options(
    aggregate: "sum",
    description: "Average TTL for keys in this database.\n",
    rollup: "avg",
    type: "gauge",
    unit: "ms"
    ), "avg_ttl"
    
  */

  stage {
    pipeline = <<-EOF
      interface "metric", metric:metric, value:value
      ${join("\n\n",
    [for metric, options in local.merged_metrics_definitions :
      indent(2,
        # format takes result of join / forloop and metric as inputs
        format("set_metric options(\n%s\n), %q",
          join(",\n",
            [for optionFieldName, optionFieldNameValue in options :
              optionFieldName == "interval" ? format("%s: %s", optionFieldName, optionFieldNameValue) :
              # format takes optionFieldName and optionFieldNameValue as inputs
              format("%s: %q", optionFieldName, optionFieldNameValue)
              if contains(var.metric_interface_fields, optionFieldName) # filters inner for loop
            ]                                                           # end of inner for loop
          ),                                                            # end of inner join statement
      replace(replace(options.google_metric_path, "compute.googleapis.com/", ""), "/", "_")))
      if contains(var.metric_launch_stages, options.launchStage) # filters outer for loop
    ]                                                            # end of outer for loop and join statement
)}  

    EOF
}
```