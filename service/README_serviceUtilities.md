## Refreshing metrics
Run ```./serviceUtilities.py -h``` for list of commands

Workflow is to run fetch_metric_descriptors and then create_terraform to create an autogenerated file with a local.metrics_definitions map variable containing metric metadata used in set_metric opal statement.

### Example

This fetches data from gcp api and creates a json file to be read by next function
```
./serviceUtilities.py fetch_metric_descriptors -o compute/computemetrics.json -m "compute.googleapis.com"
```

This reads json file and creates local_metricdescriptors.tf file with local variable defined that can be read in metrics dataset definition.

```
serviceUtilities.py create_terraform -i compute/computemetrics.json -t compute/local_metricdescriptors.tf 
```

## Changing metric definitions
Some metrics may not have correct properties for attributes needed by set_metric.  In this case we use a file called local_metricdescriptors_over_rides.tf to override certain properties in the auto generated terraform local variable.

### Example
The file defines another local variable that combines the auto generated local.metrics_definitions with another variable local.metrics_definitions_overrides.

For any metric defined in the auto generated local_metricdescriptors.tf file - for example cpu_utilization - we can create a corresponding definition that overrides specific properties of the metric in local_metricdescriptors_over_rides.tf

```
# FROM local_metricdescriptors.tf
  cpu_utilization = {
    type               = "gauge"
    description        = <<-EOF
                    Fractional utilization of allocated CPU on this instance. Values are typically numbers between 0.0 and 1.0 but some machine types allow bursting above 1.0. Charts display the values as a percentage between 0% and 100% or more. This metric is reported by the hypervisor for the VM and can differ from `agent.googleapis.com/cpu/utilization`, which is reported from inside the VM.
                EOF
    launchStage        = "GA"
    rollup             = "avg"
    aggregate          = "sum"
    metricCategory     = "cpu"
    google_metric_path = "compute.googleapis.com/instance/cpu/utilization"
    label              = "CPU utilization"
    unit               = "10^2.%"
    metricBin          = "instance"
    valuetype          = "DOUBLE"

  }
  ```

```
locals {
  override_keys = keys(local.metrics_definitions_overrides)
  # if local.metrics_definitions has an overide value in local.metrics_definitions_overrides then use value from local.metrics_definitions_overrides
  merged_metrics_definitions = { for key1, value1 in local.metrics_definitions : # loop
    key1 => {
      for key2, value2 in value1 :
      key2 => contains(local.override_keys, key1) ?                     # check if metric key in override map
      contains(keys(local.metrics_definitions_overrides[key1]), key2) ? # check if property in override map for given key
      local.metrics_definitions_overrides[key1][key2] : value2          # use if present otherwise use existing
      : value2                                                          # otherwise use existing
    }
  }


# This will change the rollup and unit properties of the cpu_utilization metric defined in local.metrics_definitions 

  metrics_definitions_overrides = {
    cpu_utilization = {
      rollup = "rate"
      unit   = "second"
    }
  }
}


```

